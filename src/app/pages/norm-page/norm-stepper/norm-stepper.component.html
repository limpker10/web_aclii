<mat-card class="max-w-5xl mx-auto p-6">
    <h2 class="text-xl font-bold mb-6">Gestión de ítems – Norma {{ normId() }}</h2>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-8">
        <!-- ITEMS -->
        <ng-container formArrayName="items">
            <mat-accordion multi>
                @for (item of items.controls; let i = $index; track item) {


                    <ng-container>
                        <mat-expansion-panel [expanded]="i === 0">
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    Item {{ i + 1 }} – {{ item.get('name')?.value || 'Nuevo' }}
                                </mat-panel-title>
                                <mat-panel-description>
                                    <button mat-icon-button type="button" color="warn" (click)="removeItem(i)">
                                        <i-feather name="trash-2"></i-feather>
                                    </button>
                                </mat-panel-description>
                            </mat-expansion-panel-header>

                            <!-- Item name -->
                            <div [formGroupName]="i" class="space-y-4 py-4 px-1">
                                <mat-form-field appearance="outline" class="w-full">
                                    <i-feather matPrefix name="tag" class="mr-2"></i-feather>
                                    <mat-label>Nombre del Item</mat-label>
                                    <input matInput formControlName="name" required placeholder="Nombre del item"/>
                                </mat-form-field>

                                <!-- SUB‑ITEMS -->
                                <h3 class="text-base font-semibold mt-4">Subítems</h3>

                                <ng-container formArrayName="subitems">
                                    @for (sub of getSubItems(i).controls; track sub; let j = $index) {

                                        <div [formGroupName]="j" class="grid md:grid-cols-2 gap-4">
                                            <mat-form-field appearance="outline" class="w-full">
                                                <i-feather matPrefix name="tag" class="mr-2"></i-feather>
                                                <mat-label>Nombre del Subítem</mat-label>
                                                <input matInput formControlName="name" required
                                                       placeholder="Nombre del subítem"/>
                                            </mat-form-field>

                                            <mat-form-field appearance="outline" class="w-full">
                                                <i-feather matPrefix name="book-open" class="mr-2"></i-feather>
                                                <mat-label>Interpretación</mat-label>
                                                <textarea matInput formControlName="interpretation" rows="3" required
                                                          placeholder="Interpretación"></textarea>
                                            </mat-form-field>

                                            <div class="flex items-center col-span-full mb-2">
                                                <button mat-icon-button type="button" color="warn"
                                                        (click)="removeSubItem(i, j)">
                                                    <i-feather name="trash-2"></i-feather>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </ng-container>

                                <button mat-stroked-button type="button" color="primary" (click)="addSubItem(i)">
                                    <i-feather name="plus" class="mr-2"></i-feather>
                                    Añadir subítem
                                </button>
                            </div>
                        </mat-expansion-panel>
                    </ng-container>
                }
            </mat-accordion>
        </ng-container>

        <!-- ACTIONS -->
        <div class="flex flex-col gap-4">
            <button mat-stroked-button type="button" color="primary" (click)="addItem()">
                <i-feather name="plus" class="mr-2"></i-feather>
                Añadir item
            </button>

            <button mat-raised-button color="primary" class="self-end" [disabled]="form.invalid">
                Guardar cambios
            </button>
        </div>
    </form>
</mat-card>
